---
interface Props {
  code: string;
  lang?: CodeLanguage;
  filename?: string;
  rawUrl?: string;
}

import type { CodeLanguage } from 'astro';
import CodeBlockClient from './CodeBlockClient.tsx';
import { Code } from 'astro:components';

const { code, lang = "text", filename, rawUrl } = Astro.props as Props;

---

<!-- Render the Shiki-powered server-side Code block and mount a tiny client that
     only renders the action bar and controls the already-rendered code. -->
<div class="codeblock-root relative my-4 w-full" data-wrap="on">
  <div class="prose max-w-full">
    <div class="codeblock-wrap rounded-md bg-surface relative">
      <Code code={code} theme="dracula" lang={lang} />

      <!-- Client: idle mount â€” will attach to the server-rendered code element -->
      <CodeBlockClient client:idle code={code} lang={lang} filename={filename} rawUrl={rawUrl} initialWrap={true} allowToggle={true} />
    </div>
  </div>
</div>

<style>
  /* Prefer UnoCSS/Tailwind utility classes for visuals. Keep a small fallback for
     z-index and hit-area handling below. */
  /* Code block layout: allow horizontal scrolling without breaking page flow */
  .codeblock-wrap{
    overflow-x: auto; /* allow horizontal scroll */
    -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
    max-width: 100%;
    box-sizing: border-box;
    min-width: 0; /* allow shrinking inside flex containers */
  }

  .codeblock-root{
    min-width: 0; /* prevent the root from forcing overflow in flex parents */
  }

  .codeblock-pre{
    margin: 0; /* remove default pre margin */
    width: 100%;
    box-sizing: border-box;
  }

  /* Default: wrap code lines (wordwrap) */
  .codeblock-root[data-wrap="on"] .codeblock-code{
    white-space: pre-wrap;
    word-break: break-word;
    min-width: 0;
    overflow-wrap: anywhere;
  }

  /* Scroll mode: preserve whitespace and allow horizontal scroll */
  .codeblock-root[data-wrap="off"] .codeblock-code{
    white-space: pre;
    min-width: max-content; /* let the code determine intrinsic width so the wrapper can scroll */
    overflow-wrap: normal;
  }

  /* Minimal scoped rules: ensure the action bar stays above the code and
     provide a small non-interactive hit-area to avoid overlap issues. */
  .codeblock-action-bar{ z-index: 20; pointer-events: auto; }
  .codeblock-pre{ position: relative; }
  .codeblock-pre::after{ content: ''; position: absolute; top: .25rem; right: .25rem; width: 6.5rem; height: 2.25rem; pointer-events: none; }
</style>
